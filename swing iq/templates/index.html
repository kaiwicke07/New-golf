<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwingIQ - AI Golf Coach</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [key, setKey] = useState('');
      const [videoFile, setVideoFile] = useState(null);
      const [preview, setPreview] = useState(null);
      const [processedVideo, setProcessedVideo] = useState(null);
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState('');
      const [result, setResult] = useState(null);
      const [err, setErr] = useState(null);
      const [showSettings, setShowSettings] = useState(true);
      const fileRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem('key');
        if (saved) {
          setKey(saved);
          setShowSettings(false);
        }
      }, []);

      const saveKey = () => {
        if (key.trim()) {
          localStorage.setItem('key', key.trim());
          setShowSettings(false);
        }
      };

      const handleFilePick = (e) => {
        const f = e.target.files[0];
        if (f && f.type.startsWith('video/')) {
          setVideoFile(f);
          setPreview(URL.createObjectURL(f));
          setProcessedVideo(null);
          setResult(null);
          setErr(null);
        }
      };

      const analyzeSwing = async () => {
        if (!videoFile || !key) return;
        setLoading(true);
        setErr(null);
        
        try {
          setStatus('Tracking landmarks & calculating angles...');
          
          const formData = new FormData();
          formData.append('video', videoFile);

          const backendRes = await fetch('/analyze_video', {
            method: 'POST',
            body: formData
          });

          if (!backendRes.ok) throw new Error('Visual analysis failed. Is app.py running?');
          const backendData = await backendRes.json();
          if (backendData.error) throw new Error(backendData.error);

          setProcessedVideo(backendData.processed_video_url);
          const frameB64 = backendData.analysis_frame;

          setStatus('Consulting AI Coach...');
          
          const geminiRes = await fetch(
            'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + key,
            {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                contents: [{
                  parts: [
                    {inline_data: {mime_type: 'image/jpeg', data: frameB64}},
                    {text: 'You are a PGA golf instructor. Analyze this golf swing frame (which has computer vision overlays). Return JSON only: {"analysis": "2-3 sentences about posture, angles, and position", "issues": ["issue 1", "issue 2"], "drills": [{"name": "drill name", "purpose": "what it fixes", "steps": ["step 1", "step 2"], "frequency": "daily"}]}'}
                  ]
                }]
              })
            }
          );

          if (!geminiRes.ok) {
             const txt = await geminiRes.text();
             throw new Error('Gemini API failed: ' + txt);
          }

          const geminiData = await geminiRes.json();
          let txt = geminiData.candidates[0].content.parts[0].text;
          txt = txt.replace(/```json/g, '').replace(/```/g, '').trim();
          
          const parsed = JSON.parse(txt);
          setResult(parsed);

        } catch (e) {
          setErr(e.message);
        } finally {
          setLoading(false);
          setStatus('');
        }
      };

      if (showSettings) {
        return (
          <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-slate-800 p-8 rounded-2xl border border-slate-700">
              <h1 className="text-4xl font-bold mb-2 text-emerald-400">SwingIQ</h1>
              <p className="text-slate-400 mb-6 text-sm">Computer Vision + Gemini 2.0</p>
              <input
                type="text"
                value={key}
                onChange={e => setKey(e.target.value)}
                placeholder="Paste Gemini API Key..."
                className="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-xl text-white mb-4 focus:border-emerald-500 outline-none"
              />
              <button onClick={saveKey} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-xl font-semibold transition-colors">Start Session</button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-900 text-white p-4 font-sans">
          <div className="max-w-4xl mx-auto">
            <div className="flex justify-between items-center mb-8">
              <div className="flex items-center gap-3">
                 <div className="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center font-bold text-xl">S</div>
                 <h1 className="text-3xl font-bold text-white">SwingIQ</h1>
              </div>
              <button onClick={() => setShowSettings(true)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-slate-300">API Key</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 h-fit">
                  <h2 className="text-lg font-semibold text-emerald-400 mb-4">Input Video</h2>
                  <input ref={fileRef} type="file" accept="video/*" onChange={handleFilePick} className="hidden" />
                  
                  {!preview ? (
                    <div onClick={() => fileRef.current?.click()} className="border-2 border-dashed border-slate-600 rounded-xl p-12 text-center cursor-pointer hover:bg-slate-750 hover:border-emerald-500/50 transition-all">
                      <p className="text-xl mb-2 text-slate-200">Upload Video</p>
                    </div>
                  ) : (
                    <div>
                      <video src={processedVideo ? processedVideo : preview} controls playsInline className="w-full rounded-xl mb-4 bg-black shadow-lg" style={{maxHeight: '400px'}} />
                      <div className="flex gap-3">
                        <button onClick={() => fileRef.current?.click()} className="px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-slate-200 text-sm font-medium transition-colors">New Video</button>
                        <button onClick={analyzeSwing} disabled={loading} className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-white shadow-lg shadow-emerald-900/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex justify-center items-center gap-2">
                          {loading ? status || 'Analyzing...' : 'Analyze Swing'}
                        </button>
                      </div>
                    </div>
                  )}
                  {err && <div className="mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg"><p className="text-red-400 text-sm text-center">{err}</p></div>}
                </div>

                <div className="space-y-6">
                    {result && (
                        <>
                            <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                                <h2 className="text-xl font-bold text-emerald-400 mb-3 flex items-center gap-2"><span>‚õ≥</span> Analysis</h2>
                                <p className="text-slate-300 leading-relaxed">{result.analysis}</p>
                            </div>
                            <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                                <h2 className="text-xl font-bold text-amber-400 mb-3 flex items-center gap-2"><span>‚ö†Ô∏è</span> Key Issues</h2>
                                <div className="space-y-3">
                                    {result.issues?.map((issue, i) => (
                                        <div key={i} className="flex gap-3 bg-slate-900/50 p-3 rounded-lg"><span className="text-amber-400 font-bold font-mono">0{i + 1}</span><span className="text-slate-300">{issue}</span></div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                                <h2 className="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2"><span>üõ†Ô∏è</span> Recommended Drills</h2>
                                <div className="space-y-4">
                                    {result.drills?.map((drill, i) => (
                                        <div key={i} className="border-l-2 border-blue-500 pl-4 py-1">
                                            <h3 className="font-bold text-blue-100 text-lg">{drill.name}</h3>
                                            <p className="text-sm text-blue-400/80 mb-2">{drill.purpose}</p>
                                            <div className="inline-block bg-blue-500/10 text-blue-300 text-xs px-2 py-1 rounded">{drill.frequency}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            </div>
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>